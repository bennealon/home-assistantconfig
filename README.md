# home-assistantconfig

Home Assistant

## Fresh Install using this config

The recommended installation method is to use the hass.os image, this maintains full support for the addons and is the only supported way of running homeassistant.

If using a raspberry Pi, then Hass.os will be the operating system, doing it this way means you can forget about maintaing a linux OS underneath. If you want to install onto an existing linux install, its recommended to install as a docker container - but doing this will not install the add-on container support that you get by going with hass.os

Follow the guide here for your hardware: https://www.home-assistant.io/getting-started/

Now wait for the download to finish at: http://homeassistant.local:8123

Setup the admin user using the prompts.

Under supervisor, install the following addons:

Duck DNS
    - *note: perform the DuckDNS add-on first, the sambashare addon has been known to prevent the duck dns from writing the necessary files on first boot.*
    - Goto configuration, accept the terms, set the domain and token for the domain (obtained from duckdns login for the domain)
    - start the add-on

Samba Share
    - Goto configuration and set a secure password, this will be used for accessing the share.
    - start the add-on

Air Sonos

Once the share is active, we can access the configuration directory and checkout our code.

Navigate to the shared directory on the pi: http://<ip>/config

now checkout the code into this repository. since this config directory already contains files we will init the directory, add the remote, then checkout the branch (otherwise git complains about not empty directory)

```
git init

git remote add origin <url of this repository>

git fetch --all --prune

# checkout master, force so it overwrites any files in here that already exist
git checkout master -f

# perform a status and remove any files that are left over from the previous config.
git status

rm -rf <file name>

git commit -am 'my message'

git push origin master
```

Restart home assistant.


In the autogenerated file known_devices.yaml, find the iphones you want to track from the router, rename if necessary and enable tracking.

once the configuration is all loaded, go into configuration -> persons, and remove the non-yaml people (duplicates), you might need to rename the user entities that are now in the database to match the expected, eg person.ben_nealon







## Secure the raspberry Pi.

https://www.home-assistant.io/docs/configuration/securing/

Change the default username on the Pi to something else, best to do this directly on the Pi itself, then disable auto-login from within the config:
https://thepihut.com/blogs/raspberry-pi-tutorials/how-to-change-the-default-account-username-and-password
note: i had trouble doing this remotely, as the pi by default auto-logs in as the default user `pi`, which means processes are still running under this user.

Setup SSH and disable username/password login, Copy over ssh key if you already have one, best way is to use `ssh-copy-id` method
https://www.digitalocean.com/community/tutorials/how-to-set-up-ssh-keys-on-debian-9

The below portion of this guide is out of date, installation has now changed and i am about to try a reinstall of hass.os


Once installed, add a system service using this guide:
https://www.home-assistant.io/docs/autostart/systemd/
Add the lines at the bottom for auto-restart on failure.

install and setup smb as a share for homeassistant
ensure homeassistant gets a samba password.
http://riccardotramma.com/2018/10/use-samba-to-configure-home-assistant/

// Setup the security.
https://www.home-assistant.io/docs/ecosystem/certificates/lets_encrypt/
in step 8, use option 2 to add as an automation.

```
there is an issue with ./certbot-auto on

https://certbot.eff.org/lets-encrypt/debianstretch-other
https://community.letsencrypt.org/t/no-public-key-for-backports/79558
https://rolfje.wordpress.com/2017/06/09/installing-gpg-keys-for-debian-backports/

the keyserver doesnt exist above, use this instead:
gpg --keyserver hkp://keys.gnupg.net --recv-keys 04EE7237B7D453EC 648ACFD622F3D138

EDIT:
// followed the pip.conf pip wheels removal step ONLY WORKS
https://community.letsencrypt.org/t/certbot-auto-certificates-fails-while-installing-phyton-packages-with-these-packages-do-not-match-the-hashes/90363/6

I found my pip config:

root@moon:~# cat /etc/pip.conf

[global]

extra-index-url=https://www.piwheels.org/simple
I deleted the /etc/pip.conf file and certboot managed to work again

```

make sure to -R these commands:

```
sudo chmod -R 755 /etc/letsencrypt/live/
sudo chmod -R 755 /etc/letsencrypt/archive/
```

// Ignore this, still occurs, but not really an issue.
If when restarting during step 5, you get similar error to this:
https://community.home-assistant.io/t/getting-error-doing-job-ssl-handshake-failed-spam-in-log-any-ideas/63510

Ensure that the dns entry does not have the port on the end.

# TODO

when kettle power drops, turn off after 30 seconds.
add bedroom light scenes
add bedroom wakeup light.
google tts when tumble finished.
google home integration
re-try heatmiser config - still broken
